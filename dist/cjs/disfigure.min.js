/*! disfigure v0.0.10 */
"use strict";var t=require("three/tsl"),e=require("three");function o(t,e,o=0){return e*t/1e3+o}function s(t,s){return new e.Vector3(o(t[0],s.scale,s.x),o(t[1],s.scale,s.y),o(t[2],s.scale,s.z))}function i(t){var e=Object.assign(Object.create(t),t);return e.pivot=e.pivot.clone(),e.pivot.x*=-1,e}class a{constructor(t,e,i,a=0,n){this.pivot=s(e,t),this.minY=o(i[0],t.scale,t.y),this.maxY=o(i[1],t.scale,t.y),n&&(this.minX=o(n[0],t.scale,t.x),this.maxX=o(n[1],t.scale,t.x)),this.slope=Math.tan((90-a)*Math.PI/180)}mirror(){var t=i(this);return"minX"in t&&(t.minX*=-1,t.maxX*=-1),t}locus(e=t.positionGeometry){var o=e.x,s=e.y,i=e.z;0!=this.angle&&(s=s.add(i.sub(this.pivot.z).div(this.slope)));var a=R(this.minY,this.maxY,s);return"minX"in this&&(a=a.max(R(this.minX,this.maxX,o.abs().add(s.sub(this.pivot.y))))),a}}class n{constructor(t,e,i,a=0){this.pivot=s(e,t),this.minX=o(i[0],t.scale,t.x),this.maxX=o(i[1],t.scale,t.x),this.slope=Math.tan((90-a)*Math.PI/180)}mirror(){var t=i(this);return t.minX*=-1,t.maxX*=-1,t}locus(e=t.positionGeometry){var o=e.x,s=e.z,i=t.float(this.minX),a=t.float(this.maxX);if(0!=this.angle){var n=s.sub(this.pivot.z).div(this.slope).max(.01).mul(o.sign());i=i.sub(n),a=a.add(n)}return R(i,a,o)}}class r extends n{constructor(t,e,s,i){super(t,e,s),this.minY=o(i[0],t.scale,t.y),this.maxY=o(i[1],t.scale,t.y)}locus(e=t.positionGeometry){var o=e.x,s=e.y,i=e.y.sub(this.pivot.y).div(4,o.sign()),a=.8;return t.float(1).mul(R(t.float(this.minX).sub(i),t.float(this.maxX).sub(i),o)).mul(t.min(R(this.minY,this.minY*a+(1-a)*this.maxY,s),R(this.maxY,this.maxY*a+(1-a)*this.minY,s))).pow(2)}}class m extends r{constructor(t,e,o,s,i=0){super(t,e,o,s),this.grown=i}locus(e=t.positionGeometry){var o=e.x,s=e.z;if(0==this.grown)var i=e.y.sub(o.abs().mul(.2)).add(s.mul(1/6)),a=t.vec3(e.x.mul(2),e.y,e.z.min(0)).sub(t.vec3(0,this.pivot.y,0)).length().smoothstep(0,.13).pow(10);else i=e.y.sub(o.abs().mul(.2)).add(s.abs().mul(.5)),a=t.vec3(e.x.mul(2),e.y,e.z.min(0)).sub(t.vec3(0,this.pivot.y,0)).length().smoothstep(0,.065).pow(10);return t.float(a).mul(o.smoothstep(this.minX,this.maxX),R(this.minY,this.maxY,i).pow(2))}}class l{constructor(t,e){const o={LocusT:m,LocusX:n,LocusXY:r,LocusY:a};for(var s in e)if("_"!=s){var i=o[e[s].shift()];e[s]=new i(t,...e[s])}this._=e._,this.head=e.head,this.chest=e.chest,this.waist=e.waist,this.kneeLeft=e?.kneeLeft??e.knee,this.kneeRight=e?.kneeRight??e.knee.mirror(),this.ankleLeft=e?.ankleLeft??e.ankle,this.ankleRight=e?.ankleRight??e.ankle.mirror(),this.ankleLongLeft=e?.ankleLongLeft??e.ankleLong,this.ankleLongRight=e?.ankleLongRight??e.ankleLong.mirror(),this.legLongLeft=e?.legLongLeft??e.legLong,this.legLongRight=e?.legLongRight??e.legLong.mirror(),this.footLeft=e?.footLeft??e.foot,this.footRight=e?.footRight??e.foot.mirror(),this.legLeft=e?.legLeft??e.leg,this.legRight=e?.legRight??e.leg.mirror(),this.elbowLeft=e?.elbowLeft??e.elbow,this.elbowRight=e?.elbowRight??e.elbow.mirror(),this.forearmLeft=e?.forearmLeft??e.forearm,this.forearmRight=e?.forearmRight??e.forearm.mirror(),this.wristLeft=e?.wristLeft??e.wrist,this.wristRight=e?.wristRight??e.wrist.mirror(),this.armLeft=e?.armLeft??e.arm,this.armRight=e?.armRight??e.arm.mirror()}}const u=t.Fn((([e])=>{var o=e.cos().toVar(),s=e.sin().toVar();return t.mat3(1,0,0,0,o,s,0,s.negate(),o)})).setLayout({name:"matRotX",type:"mat3",inputs:[{name:"angle",type:"float"}]}),g=t.Fn((([e])=>{var o=e.cos().toVar(),s=e.sin().toVar();return t.mat3(o,0,s.negate(),0,1,0,s,0,o)})).setLayout({name:"matRotY",type:"mat3",inputs:[{name:"angle",type:"float"}]}),h=t.Fn((([e])=>{var o=e.cos().toVar(),s=e.sin().toVar();return t.mat3(o,s,0,s.negate(),o,0,0,0,1)})).setLayout({name:"matRotZ",type:"mat3",inputs:[{name:"angle",type:"float"}]}),f=t.Fn((([t])=>{var e=u(t.x),o=g(t.y),s=h(t.z);return o.mul(e).mul(s)})).setLayout({name:"matRotYXZ",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),c=t.Fn((([t])=>{var e=u(t.x),o=g(t.y),s=h(t.z);return o.mul(s).mul(e)})).setLayout({name:"matRotYZX",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),p=t.Fn((([t])=>{var e=u(t.x),o=g(t.y),s=h(t.z);return e.mul(o).mul(s)})).setLayout({name:"matRotXYZ",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),v=t.Fn((([t])=>{var e=u(t.x),o=g(t.y),s=h(t.z);return e.mul(s).mul(o)})).setLayout({name:"matRotXZY",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),L=t.Fn((([t])=>{var e=u(t.x),o=g(t.y);return h(t.z).mul(e).mul(o)})).setLayout({name:"matRotZXY",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),y=t.Fn((([t])=>{var e=u(t.x),o=g(t.y);return h(t.z).mul(o).mul(e)})).setLayout({name:"matRotZYX",type:"mat3",inputs:[{name:"angles",type:"vec3"}]});const R=t.Fn((([t,e,o])=>o.smoothstep(t,e).smoothstep(0,1).smoothstep(0,1))).setLayout({name:"smoother",type:"float",inputs:[{name:"edgeFrom",type:"float"},{name:"edgeTo",type:"float"},{name:"value",type:"float"}]});var x=t.Fn((([t,e,o,s])=>t.sub(e).mul(c(o.mul(s))).add(e))).setLayout({name:"jointRotate",type:"vec3",inputs:[{name:"pos",type:"vec3"},{name:"center",type:"vec3"},{name:"angle",type:"vec3"},{name:"amount",type:"float"}]}),d=t.Fn((([t,e,o,s])=>t.sub(e).mul(v(o.mul(s))).add(e).toVar())).setLayout({name:"jointRotate2",type:"vec3",inputs:[{name:"pos",type:"vec3"},{name:"center",type:"vec3"},{name:"angle",type:"vec3"},{name:"amount",type:"float"}]});var w=t.Fn((({space:e,posture:o,mode:s,vertex:i})=>{var a=i.toVar(),n=e.armLeft.locus().toVar();t.If(n.greaterThan(0),(()=>{a.assign(x(a,s.mul(e.wristLeft.pivot),o.wristLeft,e.wristLeft.locus())),a.assign(x(a,s.mul(e.forearmLeft.pivot),o.forearmLeft,e.forearmLeft.locus())),a.assign(x(a,s.mul(e.elbowLeft.pivot),o.elbowLeft,e.elbowLeft.locus())),a.assign(d(a,s.mul(e.armLeft.pivot),o.armLeft,e.armLeft.locus()))}));var r=e.armRight.locus().toVar();t.If(r.greaterThan(0),(()=>{a.assign(x(a,s.mul(e.wristRight.pivot),o.wristRight,e.wristRight.locus())),a.assign(x(a,s.mul(e.forearmRight.pivot),o.forearmRight,e.forearmRight.locus())),a.assign(x(a,s.mul(e.elbowRight.pivot),o.elbowRight,e.elbowRight.locus())),a.assign(d(a,s.mul(e.armRight.pivot),o.armRight,e.armRight.locus()))})),a.assign(x(a,s.mul(e.head.pivot),o.head,e.head.locus())),a.assign(x(a,s.mul(e.chest.pivot),o.chest,e.chest.locus())),a.assign(x(a,s.mul(e.waist.pivot),o.waist,e.waist.locus()));var m=e.legLeft.locus().toVar();t.If(m.greaterThan(0),(()=>{a.assign(x(a,s.mul(e.footLeft.pivot),o.footLeft,e.footLeft.locus())),a.assign(x(a,s.mul(e.ankleLeft.pivot),o.ankleLeft,e.ankleLeft.locus())),a.assign(x(a,s.mul(e.ankleLongLeft.pivot),o.ankleLongLeft,e.ankleLongLeft.locus())),a.assign(x(a,s.mul(e.kneeLeft.pivot),o.kneeLeft,e.kneeLeft.locus())),a.assign(x(a,s.mul(e.legLongLeft.pivot),o.legLongLeft,e.legLongLeft.locus())),a.assign(x(a,s.mul(e.legLeft.pivot),o.legLeft,m))}));var l=e.legRight.locus().toVar();return t.If(l.greaterThan(0),(()=>{a.assign(x(a,s.mul(e.footRight.pivot),o.footRight,e.footRight.locus())),a.assign(x(a,s.mul(e.ankleRight.pivot),o.ankleRight,e.ankleRight.locus())),a.assign(x(a,s.mul(e.ankleLongRight.pivot),o.ankleLongRight,e.ankleLongRight.locus())),a.assign(x(a,s.mul(e.kneeRight.pivot),o.kneeRight,e.kneeRight.locus())),a.assign(x(a,s.mul(e.legLongRight.pivot),o.legLongRight,e.legLongRight.locus())),a.assign(x(a,s.mul(e.legRight.pivot),o.legRight,l))})),a}));exports.LocusT=m,exports.LocusX=n,exports.Space=l,exports.decode=o,exports.encode=function(t,e,o=0){return 1e3*(t-o)/e},exports.matRotXYZ=p,exports.matRotXZY=v,exports.matRotYXZ=f,exports.matRotYZX=c,exports.matRotZXY=L,exports.matRotZYX=y,exports.processModel=function(t,o,s,i,a={}){var n={};return function(t,o){var s=[];t.traverse((t=>{if(t.isMesh){var i=t.geometry.clone().applyMatrix4(t.matrixWorld),a=t.material.clone();if(o[0]&&i.rotateX(o[0]),o[1]&&i.rotateY(o[1]),o[2]&&i.rotateZ(o[2]),t.isSkinnedMesh){t.pose();for(var n=i.getAttribute("position"),r=i.getAttribute("normal"),m=new e.Vector3,l=0;l<n.count;l++)m.fromBufferAttribute(n,l),t.applyBoneTransform(l,m),n.setXYZ(l,...m),m.fromBufferAttribute(r,l),t.applyBoneTransform(l,m),r.setXYZ(l,...m)}var u=new e.Mesh(i,a);u.frustumCulled=!1,s.push(u)}})),t.clear(),t.position.set(0,0,0),t.rotation.set(0,0,0,"XYZ"),t.scale.set(1,1,1),t.add(...s)}(t,o?._?.rot??[0,0,0]),function(t,o){var s=new e.Vector3,i=(new e.Box3).setFromObject(t,!0);i.getCenter(s),t.position.sub(s),o.x=(i.max.x+i.min.x)/2,o.y=i.min.y,o.z=(i.max.z+i.min.z)/2,o.scale=Math.max(i.max.x-i.min.x,i.max.y-i.min.y,i.max.z-i.min.z)}(t,n),function(t,o,s,i,a){t.traverse((t=>{if(t.isMesh){var n=new e.MeshPhysicalNodeMaterial;Object.assign(n,t.material),Object.assign(n,a),i.colorNode&&(n.colorNode=i.colorNode()),i.positionNode&&(n.positionNode=i.positionNode({space:o,posture:s})),i.normalNode&&(n.normalNode=i.normalNode({space:o,posture:s})),i.emissiveNode&&(n.emissiveNode=i.emissiveNode({space:o,posture:s})),t.material=n}}))}(t,o=new l(n,o),s,i,a),{model:t,dims:n,space:o}},exports.smoother=R,exports.tslNormalNode=function(e){return e.vertex=t.normalGeometry,e.mode=t.float(0),t.transformNormalToView(w(e)).normalize()},exports.tslPositionNode=function(e){return e.vertex=t.positionGeometry,e.mode=t.float(1),w(e)},exports.tslPosture=function(){return{head:t.uniform(t.vec3(0,0,0)),chest:t.uniform(t.vec3(0,0,0)),waist:t.uniform(t.vec3(0,0,0)),kneeLeft:t.uniform(t.vec3(0,0,0)),kneeRight:t.uniform(t.vec3(0,0,0)),ankleLeft:t.uniform(t.vec3(0,0,0)),ankleRight:t.uniform(t.vec3(0,0,0)),footLeft:t.uniform(t.vec3(0,0,0)),footRight:t.uniform(t.vec3(0,0,0)),legLeft:t.uniform(t.vec3(0,0,0)),legLongLeft:t.uniform(t.vec3(0,0,0)),legRight:t.uniform(t.vec3(0,0,0)),legLongRight:t.uniform(t.vec3(0,0,0)),ankleLongLeft:t.uniform(t.vec3(0,0,0)),ankleLongRight:t.uniform(t.vec3(0,0,0)),elbowLeft:t.uniform(t.vec3(0,0,0)),elbowRight:t.uniform(t.vec3(0,0,0)),forearmLeft:t.uniform(t.vec3(0,0,0)),forearmRight:t.uniform(t.vec3(0,0,0)),wristLeft:t.uniform(t.vec3(0,0,0)),wristRight:t.uniform(t.vec3(0,0,0)),armLeft:t.uniform(t.vec3(0,0,0)),armRight:t.uniform(t.vec3(0,0,0))}};
