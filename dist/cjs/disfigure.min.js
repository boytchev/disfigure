/*! disfigure v0.0.9 */
"use strict";var t=require("three/tsl"),e=require("three");function o(t,e,o){return e*t/1e3+o}function s(t,s){return new e.Vector3(o(t[0],s.scale,s.x),o(t[1],s.scale,s.y),o(t[2],s.scale,s.z))}function i(t){var e=Object.assign(Object.create(t),t);return e.pivot=e.pivot.clone(),e.pivot.x*=-1,e}class a{constructor(t,e,i){this.pivot=s(e,t),this.minX=o(i[0],t.scale,t.x),this.maxX=o(i[1],t.scale,t.x)}mirror(){var t=i(this);return t.minX*=-1,t.maxX*=-1,t}locus(){return t.positionGeometry.x.smoothstep(this.minX,this.maxX)}}class r extends a{constructor(t,e,s,i){super(t,e,s),this.minY=o(i[0],t.scale,t.y),this.maxY=o(i[1],t.scale,t.y)}locus(){var e=t.positionGeometry.x.smoothstep(this.minX,this.maxX),o=t.positionGeometry.y.smoothstep(this.minY,this.maxY);return e.mul(o)}}class l{constructor(t,e){for(var o in e){var s=e[o].shift();e[o]=new s(t,...e[o])}this.head=e.head,this.chest=e.chest,this.waist=e.waist,this.kneeLeft=e?.kneeLeft??e.knee,this.kneeRight=e?.kneeRight??e.knee.mirror(),this.ankleLeft=e?.ankleLeft??e.ankle,this.ankleRight=e?.ankleRight??e.ankle.mirror(),this.legLeft=e?.legLeft??e.leg,this.legRight=e?.legRight??e.leg.mirror(),this.hip2Left=e?.hip2Left??e.hip2,this.hip2Right=e?.hip2Right??e.hip2.mirror(),this.footLeft=e?.footLeft??e.foot,this.footRight=e?.footRight??e.foot.mirror(),this.hipLeft=e?.hipLeft??e.hip,this.hipRight=e?.hipRight??e.hip.mirror(),this.elbowLeft=e?.elbowLeft??e.elbow,this.elbowRight=e?.elbowRight??e.elbow.mirror(),this.forearmLeft=e?.forearmLeft??e.forearm,this.forearmRight=e?.forearmRight??e.forearm.mirror(),this.wristLeft=e?.wristLeft??e.wrist,this.wristRight=e?.wristRight??e.wrist.mirror(),this.armLeft=e?.armLeft??e.arm,this.armRight=e?.armRight??e.arm.mirror()}}const n=t.Fn((([e])=>{var o=e.cos().toVar(),s=e.sin().toVar();return t.mat3(1,0,0,0,o,s,0,s.negate(),o)})).setLayout({name:"matRotX",type:"mat3",inputs:[{name:"angle",type:"float"}]}),m=t.Fn((([e])=>{var o=e.cos().toVar(),s=e.sin().toVar();return t.mat3(o,0,s.negate(),0,1,0,s,0,o)})).setLayout({name:"matRotY",type:"mat3",inputs:[{name:"angle",type:"float"}]}),u=t.Fn((([e])=>{var o=e.cos().toVar(),s=e.sin().toVar();return t.mat3(o,s,0,s.negate(),o,0,0,0,1)})).setLayout({name:"matRotZ",type:"mat3",inputs:[{name:"angle",type:"float"}]}),c=t.Fn((([t])=>{var e=n(t.x),o=m(t.y),s=u(t.z);return o.mul(e).mul(s)})).setLayout({name:"matRotYXZ",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),h=t.Fn((([t])=>{var e=n(t.x),o=m(t.y),s=u(t.z);return o.mul(s).mul(e)})).setLayout({name:"matRotYZX",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),p=t.Fn((([t])=>{var e=n(t.x),o=m(t.y),s=u(t.z);return e.mul(o).mul(s)})).setLayout({name:"matRotXYZ",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),f=t.Fn((([t])=>{var e=n(t.x),o=m(t.y),s=u(t.z);return e.mul(s).mul(o)})).setLayout({name:"matRotXZY",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),g=t.Fn((([t])=>{var e=n(t.x),o=m(t.y);return u(t.z).mul(e).mul(o)})).setLayout({name:"matRotZXY",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),v=t.Fn((([t])=>{var e=n(t.x),o=m(t.y);return u(t.z).mul(o).mul(e)})).setLayout({name:"matRotZYX",type:"mat3",inputs:[{name:"angles",type:"vec3"}]});var d=t.Fn((([t,e,o,s])=>t.sub(e).mul(c(o.mul(s))).add(e))).setLayout({name:"jointRotate",type:"vec3",inputs:[{name:"pos",type:"vec3"},{name:"center",type:"vec3"},{name:"angle",type:"vec3"},{name:"amount",type:"float"}]}),R=t.Fn((([e,o,s,i])=>t.mix(e,e.sub(o).mul(f(s.mul(i))).mul(t.float(1).sub(i.mul(2*Math.PI).sub(Math.PI).cos().add(1).div(2).div(4).mul(s.z.cos().oneMinus()))).add(o),i.pow(.25)))).setLayout({name:"jointRotate2",type:"vec3",inputs:[{name:"pos",type:"vec3"},{name:"center",type:"vec3"},{name:"angle",type:"vec3"},{name:"amount",type:"float"}]});var L=t.Fn((({space:e,posture:o,mode:s,vertex:i})=>{var a=i.toVar(),r=e.armLeft.locus().toVar();t.If(r.greaterThan(0),(()=>{a.assign(d(a,s.mul(e.wristLeft.pivot),o.wristLeft,e.wristLeft.locus())),a.assign(d(a,s.mul(e.forearmLeft.pivot),o.forearmLeft,e.forearmLeft.locus())),a.assign(d(a,s.mul(e.elbowLeft.pivot),o.elbowLeft,e.elbowLeft.locus())),a.assign(R(a,s.mul(e.armLeft.pivot),o.armLeft,r))}));var l=e.armRight.locus().toVar();t.If(l.greaterThan(0),(()=>{a.assign(d(a,s.mul(e.wristRight.pivot),o.wristRight,e.wristRight.locus())),a.assign(d(a,s.mul(e.forearmRight.pivot),o.forearmRight,e.forearmRight.locus())),a.assign(d(a,s.mul(e.elbowRight.pivot),o.elbowRight,e.elbowRight.locus())),a.assign(R(a,s.mul(e.armRight.pivot),o.armRight,l))})),a.assign(d(a,s.mul(e.head.pivot),o.head,e.head.locus())),a.assign(d(a,s.mul(e.chest.pivot),o.chest,e.chest.locus())),a.assign(d(a,s.mul(e.waist.pivot),o.waist,e.waist.locus()));var n=e.hipLeft.locus().toVar();t.If(n.greaterThan(0),(()=>{a.assign(d(a,s.mul(e.footLeft.pivot),o.footLeft,e.footLeft.locus())),a.assign(d(a,s.mul(e.ankleLeft.pivot),o.ankleLeft,e.ankleLeft.locus())),a.assign(d(a,s.mul(e.legLeft.pivot),o.legLeft,e.legLeft.locus())),a.assign(d(a,s.mul(e.kneeLeft.pivot),o.kneeLeft,e.kneeLeft.locus())),a.assign(d(a,s.mul(e.hip2Left.pivot),o.hip2Left,e.hip2Left.locus())),a.assign(d(a,s.mul(e.hipLeft.pivot),o.hipLeft,n))}));var m=e.hipRight.locus().toVar();return t.If(m.greaterThan(0),(()=>{a.assign(d(a,s.mul(e.footRight.pivot),o.footRight,e.footRight.locus())),a.assign(d(a,s.mul(e.ankleRight.pivot),o.ankleRight,e.ankleRight.locus())),a.assign(d(a,s.mul(e.legRight.pivot),o.legRight,e.legRight.locus())),a.assign(d(a,s.mul(e.kneeRight.pivot),o.kneeRight,e.kneeRight.locus())),a.assign(d(a,s.mul(e.hip2Right.pivot),o.hip2Right,e.hip2Right.locus())),a.assign(d(a,s.mul(e.hipRight.pivot),o.hipRight,m))})),a})),y=t.Fn((({space:e,posture:o})=>{var s=o.select,i=t.float(0).add(e.head.locus().mul(t.select(s.equal(1),1,0))).add(e.chest.locus().mul(t.select(s.equal(2),1,0))).add(e.waist.locus().mul(t.select(s.equal(3),1,0))).add(e.hipLeft.locus().mul(t.select(s.equal(11),1,0))).add(e.hipRight.locus().mul(t.select(s.equal(11),1,0))).add(e.legLeft.locus().mul(t.select(s.equal(12),1,0))).add(e.legRight.locus().mul(t.select(s.equal(12),1,0))).add(e.kneeLeft.locus().mul(t.select(s.equal(13),1,0))).add(e.kneeRight.locus().mul(t.select(s.equal(13),1,0))).add(e.ankleLeft.locus().mul(t.select(s.equal(14),1,0))).add(e.ankleRight.locus().mul(t.select(s.equal(14),1,0))).add(e.footLeft.locus().mul(t.select(s.equal(16),1,0))).add(e.footRight.locus().mul(t.select(s.equal(16),1,0))).add(e.hip2Left.locus().mul(t.select(s.equal(15),1,0))).add(e.hip2Right.locus().mul(t.select(s.equal(15),1,0))).add(e.armLeft.locus().mul(t.select(s.equal(21),1,0))).add(e.armRight.locus().mul(t.select(s.equal(21),1,0))).add(e.elbowLeft.locus().mul(t.select(s.equal(22),1,0))).add(e.elbowRight.locus().mul(t.select(s.equal(22),1,0))).add(e.forearmLeft.locus().mul(t.select(s.equal(23),1,0))).add(e.forearmRight.locus().mul(t.select(s.equal(23),1,0))).add(e.wristLeft.locus().mul(t.select(s.equal(24),1,0))).add(e.wristRight.locus().mul(t.select(s.equal(24),1,0))).clamp(0,1).negate().toVar(),a=t.vec3(t.float(-1).sub(i),i.div(2),i.div(.5)).toVar();return t.If(i.lessThan(-.99),(()=>{a.assign(t.vec3(0,0,0))})),t.If(i.greaterThan(-.01),(()=>{a.assign(t.vec3(0,0,0))})),a})),x=t.Fn((()=>{var e=t.positionGeometry,o=t.float(0).add(e.x.mul(72).cos().smoothstep(.9,1)).add(e.y.mul(74).cos().smoothstep(.9,1)).add(e.z.mul(74).add(e.y.mul(4.5).add(.5).cos().mul(1).add(2.5)).abs().smoothstep(.6,0)).smoothstep(.6,1).oneMinus().pow(.1);return t.vec3(o)}));exports.LocusT=class extends r{constructor(t,e,s,i,a){super(t,e,s,i),this.topY=o(a,t.scale,t.y)}locus(){var e=t.positionGeometry.x.toVar(),o=t.positionGeometry.y;return o.step(this.topY).mul(e.smoothstep(this.minX,this.maxX)).mul(o.smoothstep(e.abs().div(.7).add(this.minY),e.abs().div(7).add(this.maxY))).pow(2)}},exports.LocusX=a,exports.LocusXY=r,exports.LocusY=class{constructor(t,e,i,a=0){this.pivot=s(e,t),this.minY=o(i[0],t.scale,t.y),this.maxY=o(i[1],t.scale,t.y),this.slope=Math.tan((90-a)*Math.PI/180)}mirror(){return i(this)}locus(){var e=t.positionGeometry.y;return 0!=this.angle&&(e=e.add(t.positionGeometry.z.div(this.slope))),e.smoothstep(this.minY,this.maxY)}},exports.Space=l,exports.matRotXYZ=p,exports.matRotXZY=f,exports.matRotYXZ=c,exports.matRotYZX=h,exports.matRotZXY=g,exports.matRotZYX=v,exports.processModel=function(t,o,s,i,a={}){var r={};return function(t){var o=[];t.traverse((t=>{if(t.isMesh){var s=t.geometry.clone().applyMatrix4(t.matrixWorld),i=t.material.clone();if(t.isSkinnedMesh){t.pose();for(var a=s.getAttribute("position"),r=s.getAttribute("normal"),l=new e.Vector3,n=0;n<a.count;n++)l.fromBufferAttribute(a,n),t.applyBoneTransform(n,l),a.setXYZ(n,...l),l.fromBufferAttribute(r,n),t.applyBoneTransform(n,l),r.setXYZ(n,...l)}var m=new e.Mesh(s,i);m.frustumCulled=!1,o.push(m)}})),t.clear(),t.position.set(0,0,0),t.rotation.set(0,0,0,"XYZ"),t.scale.set(1,1,1),t.add(...o)}(t),function(t,o){var s=new e.Vector3,i=(new e.Box3).setFromObject(t,!0);i.getCenter(s),t.position.sub(s),o.x=(i.max.x+i.min.x)/2,o.y=i.min.y,o.z=(i.max.z+i.min.z)/2,o.scale=Math.max(i.max.x-i.min.x,i.max.y-i.min.y,i.max.z-i.min.z)}(t,r),function(t,o,s,i,a){t.traverse((t=>{if(t.isMesh){var r=new e.MeshPhysicalNodeMaterial;Object.assign(r,t.material),Object.assign(r,a),i.colorNode&&(r.colorNode=i.colorNode()),i.positionNode&&(r.positionNode=i.positionNode({space:o,posture:s})),i.normalNode&&(r.normalNode=i.normalNode({space:o,posture:s})),i.emissiveNode&&(r.emissiveNode=i.emissiveNode({space:o,posture:s})),t.material=r}}))}(t,o=new l(r,o),s,i,a),{model:t,dims:r,space:o}},exports.tslColorNode=x,exports.tslEmissiveNode=y,exports.tslNormalNode=function(e){return e.vertex=t.normalGeometry,e.mode=t.float(0),t.transformNormalToView(L(e)).normalize()},exports.tslPositionNode=function(e){return e.vertex=t.positionGeometry,e.mode=t.float(1),L(e)},exports.tslPosture=function(){return{head:t.uniform(t.vec3(0,0,0)),chest:t.uniform(t.vec3(0,0,0)),waist:t.uniform(t.vec3(0,0,0)),kneeLeft:t.uniform(t.vec3(0,0,0)),kneeRight:t.uniform(t.vec3(0,0,0)),ankleLeft:t.uniform(t.vec3(0,0,0)),ankleRight:t.uniform(t.vec3(0,0,0)),footLeft:t.uniform(t.vec3(0,0,0)),footRight:t.uniform(t.vec3(0,0,0)),hipLeft:t.uniform(t.vec3(0,0,0)),hip2Left:t.uniform(t.vec3(0,0,0)),hipRight:t.uniform(t.vec3(0,0,0)),hip2Right:t.uniform(t.vec3(0,0,0)),legLeft:t.uniform(t.vec3(0,0,0)),legRight:t.uniform(t.vec3(0,0,0)),elbowLeft:t.uniform(t.vec3(0,0,0)),elbowRight:t.uniform(t.vec3(0,0,0)),forearmLeft:t.uniform(t.vec3(0,0,0)),forearmRight:t.uniform(t.vec3(0,0,0)),wristLeft:t.uniform(t.vec3(0,0,0)),wristRight:t.uniform(t.vec3(0,0,0)),armLeft:t.uniform(t.vec3(0,0,0)),armRight:t.uniform(t.vec3(0,0,0))}};
