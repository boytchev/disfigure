/*! disfigure v0.0.9 */
"use strict";var e=require("three"),t=require("three/tsl");const o=t.Fn((([e])=>{var o=e.cos().toVar(),s=e.sin().toVar();return t.mat3(1,0,0,0,o,s,0,s.negate(),o)})).setLayout({name:"matRotX",type:"mat3",inputs:[{name:"angle",type:"float"}]}),s=t.Fn((([e])=>{var o=e.cos().toVar(),s=e.sin().toVar();return t.mat3(o,0,s.negate(),0,1,0,s,0,o)})).setLayout({name:"matRotY",type:"mat3",inputs:[{name:"angle",type:"float"}]}),i=t.Fn((([e])=>{var o=e.cos().toVar(),s=e.sin().toVar();return t.mat3(o,s,0,s.negate(),o,0,0,0,1)})).setLayout({name:"matRotZ",type:"mat3",inputs:[{name:"angle",type:"float"}]}),r=t.Fn((([e])=>{var t=o(e.x),r=s(e.y),a=i(e.z);return r.mul(t).mul(a)})).setLayout({name:"matRotYXZ",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),a=t.Fn((([e])=>{var t=o(e.x),r=s(e.y),a=i(e.z);return r.mul(a).mul(t)})).setLayout({name:"matRotYZX",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),m=t.Fn((([e])=>{var t=o(e.x),r=s(e.y),a=i(e.z);return t.mul(r).mul(a)})).setLayout({name:"matRotXYZ",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),n=t.Fn((([e])=>{var t=o(e.x),r=s(e.y),a=i(e.z);return t.mul(a).mul(r)})).setLayout({name:"matRotXZY",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),u=t.Fn((([e])=>{var t=o(e.x),r=s(e.y);return i(e.z).mul(t).mul(r)})).setLayout({name:"matRotZXY",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),d=t.Fn((([e])=>{var t=o(e.x),r=s(e.y);return i(e.z).mul(r).mul(t)})).setLayout({name:"matRotZYX",type:"mat3",inputs:[{name:"angles",type:"vec3"}]});class h{constructor(t,o,s){this.dims=t,this.pivot=new e.Vector3(o[0],o[1],o[2]),this.mirrorPivot=new e.Vector3(-o[0],o[1],o[2]),this.min=s[0],this.max=s[1]}encodeX(e){var t=Math.round(1e3*(e-this.dims.x)/this.dims.scale);return console.log(e.toFixed(4),"→",t,"→",this.decodeX(t).toFixed(4),"(",(this.decodeX(t)/e*100-100).toFixed(4)),t}decodeX(e){return this.dims.scale*e/1e3+this.dims.x}encodeY(e){var t=Math.round(1e3*(e-this.dims.y)/this.dims.scale);return console.log(e.toFixed(4),"→",t,"→",this.decodeY(t).toFixed(4),"(",(this.decodeY(t)/e*100-100).toFixed(4)),t}decodeY(e){return this.dims.scale*e/1e3+this.dims.y}encodeZ(e){var t=Math.round(1e3*(e-this.dims.z)/this.dims.scale);return console.log(e.toFixed(4),"→",t,"→",this.decodeZ(t).toFixed(4),"(",(this.decodeZ(t)/e*100-100).toFixed(4)),t}decodeZ(e){return this.dims.scale*e/1e3+this.dims.z}decode(){this.pivot.x=this.decodeX(this.pivot.x),this.pivot.y=this.decodeY(this.pivot.y),this.pivot.z=this.decodeZ(this.pivot.z),this.mirrorPivot.x=this.decodeX(this.mirrorPivot.x),this.mirrorPivot.y=this.decodeY(this.mirrorPivot.y),this.mirrorPivot.z=this.decodeZ(this.mirrorPivot.z)}}class l extends h{constructor(e,t,o){super(e,t,o),this.decode()}decode(){super.decode(),this.min=this.decodeY(this.min),this.max=this.decodeY(this.max)}fuzzy(){return t.positionGeometry.y.smoothstep(this.min,this.max)}}var c=t.Fn((([e,t,o,s])=>e.sub(t).mul(r(o.mul(s))).add(t))).setLayout({name:"jointRotate",type:"vec3",inputs:[{name:"pos",type:"vec3"},{name:"center",type:"vec3"},{name:"angle",type:"vec3"},{name:"amount",type:"float"}]}),p=t.Fn((([e,o,s,i])=>t.mix(e,e.sub(o).mul(n(s.mul(i))).mul(t.float(1).sub(i.mul(2*Math.PI).sub(Math.PI).cos().add(1).div(2).div(4).mul(s.z.cos().oneMinus()))).add(o),i.pow(.25)))).setLayout({name:"jointRotate2",type:"vec3",inputs:[{name:"pos",type:"vec3"},{name:"center",type:"vec3"},{name:"angle",type:"vec3"},{name:"amount",type:"float"}]});var y=t.Fn((({skeleton:e,posture:o,mode:s,vertex:i})=>{var r=i.toVar(),a=e.arm.fuzzy().toVar();t.If(a.greaterThan(0),(()=>{r.assign(c(r,s.mul(e.wrist.pivot),o.wristLeft,e.wrist.fuzzy())),r.assign(c(r,s.mul(e.forearm.pivot),o.forearmLeft,e.forearm.fuzzy())),r.assign(c(r,s.mul(e.elbow.pivot),o.elbowLeft,e.elbow.fuzzy())),r.assign(p(r,s.mul(e.arm.pivot),o.armLeft,a))}));var m=e.arm.mirrorFuzzy().toVar();t.If(m.greaterThan(0),(()=>{r.assign(c(r,s.mul(e.wrist.mirrorPivot),o.wristRight,e.wrist.mirrorFuzzy())),r.assign(c(r,s.mul(e.forearm.mirrorPivot),o.forearmRight,e.forearm.mirrorFuzzy())),r.assign(c(r,s.mul(e.elbow.mirrorPivot),o.elbowRight,e.elbow.mirrorFuzzy())),r.assign(p(r,s.mul(e.arm.mirrorPivot),o.armRight,m))})),r.assign(c(r,s.mul(e.head.pivot),o.head,e.head.fuzzy())),r.assign(c(r,s.mul(e.chest.pivot),o.chest,e.chest.fuzzy())),r.assign(c(r,s.mul(e.waist.pivot),o.waist,e.waist.fuzzy()));var n=e.hip.fuzzy().toVar();t.If(n.greaterThan(0),(()=>{r.assign(c(r,s.mul(e.foot.pivot),o.footLeft,e.foot.fuzzy())),r.assign(c(r,s.mul(e.ankle.pivot),o.ankleLeft,e.ankle.fuzzy())),r.assign(c(r,s.mul(e.leg.pivot),o.legLeft,e.leg.fuzzy())),r.assign(c(r,s.mul(e.knee.pivot),o.kneeLeft,e.knee.fuzzy())),r.assign(c(r,s.mul(e.hip2.pivot),o.hip2Left,e.hip2.fuzzy())),r.assign(c(r,s.mul(e.hip.pivot),o.hipLeft,n))}));var u=e.hip.mirrorFuzzy().toVar();return t.If(u.greaterThan(0),(()=>{r.assign(c(r,s.mul(e.foot.mirrorPivot),o.footRight,e.foot.fuzzy())),r.assign(c(r,s.mul(e.ankle.mirrorPivot),o.ankleRight,e.ankle.fuzzy())),r.assign(c(r,s.mul(e.leg.mirrorPivot),o.legRight,e.leg.fuzzy())),r.assign(c(r,s.mul(e.knee.mirrorPivot),o.kneeRight,e.knee.fuzzy())),r.assign(c(r,s.mul(e.hip2.mirrorPivot),o.hip2Right,e.hip2.fuzzy())),r.assign(c(r,s.mul(e.hip.mirrorPivot),o.hipRight,u))})),r})),f=t.Fn((({skeleton:e,posture:o})=>{var s=o.select,i=t.float(0).add(e.head.fuzzy().mul(t.select(s.equal(1),1,0))).add(e.chest.fuzzy().mul(t.select(s.equal(2),1,0))).add(e.waist.fuzzy().mul(t.select(s.equal(3),1,0))).add(e.hip.fuzzy().mul(t.select(s.equal(11),1,0))).add(e.leg.fuzzy().mul(t.select(s.equal(12),1,0))).add(e.knee.fuzzy().mul(t.select(s.equal(13),1,0))).add(e.ankle.fuzzy().mul(t.select(s.equal(14),1,0))).add(e.foot.fuzzy().mul(t.select(s.equal(16),1,0))).add(e.hip2.fuzzy().mul(t.select(s.equal(15),1,0))).add(e.arm.fuzzy().mul(t.select(s.equal(21),1,0))).add(e.elbow.fuzzy().mul(t.select(s.equal(22),1,0))).add(e.forearm.fuzzy().mul(t.select(s.equal(23),1,0))).add(e.wrist.fuzzy().mul(t.select(s.equal(24),1,0))).clamp(0,1).negate().toVar();return t.If(i.lessThan(-.999),(()=>{i.assign(.2)})),t.vec3(0,i.div(2),i.div(1))})),v=t.Fn((()=>{var e=t.positionGeometry,o=t.float(0).add(e.x.mul(72).cos().smoothstep(.9,1)).add(e.y.mul(74).cos().smoothstep(.9,1)).add(e.z.mul(74).add(e.y.mul(4.5).add(.5).cos().mul(1).add(2.5)).abs().smoothstep(.6,0)).smoothstep(.6,1).oneMinus().pow(.1);return t.vec3(o)}));exports.LocusT=class extends h{constructor(e,t,o,s,i){super(e,t,o),this.topY=s,this.minX=i[0],this.maxX=i[1],this.decode()}decode(){super.decode(),this.min=this.decodeY(this.min),this.max=this.decodeY(this.max),this.topY=this.decodeY(this.topY),this.minX=this.decodeX(this.minX),this.maxX=this.decodeX(this.maxX)}fuzzy(){var e=t.positionGeometry.x.toVar(),o=t.positionGeometry.y;return o.step(this.topY).mul(e.smoothstep(this.minX,this.maxX)).mul(o.smoothstep(e.div(.7).add(this.min),e.div(7).add(this.max))).pow(2)}mirrorFuzzy(){var e=t.positionGeometry.x,o=t.positionGeometry.y;return o.step(this.topY).mul(e.smoothstep(-this.minX,-this.maxX)).mul(o.smoothstep(e.div(-.7).add(this.min),e.div(-7).add(this.max))).pow(2)}},exports.LocusX=class extends h{constructor(e,t,o){super(e,t,o),this.decode()}decode(){super.decode(),this.min=this.decodeX(this.min),this.max=this.decodeX(this.max)}fuzzy(){return t.positionGeometry.x.smoothstep(this.min,this.max)}mirrorFuzzy(){return t.positionGeometry.x.smoothstep(-this.min,-this.max)}},exports.LocusXY=class extends h{constructor(e,t,o,s){super(e,t,o),this.minY=s[0],this.maxY=s[1],this.decode()}decode(){super.decode(),this.min=this.decodeX(this.min),this.max=this.decodeX(this.max),this.minY=this.decodeY(this.minY),this.maxY=this.decodeY(this.maxY)}fuzzy(){var e=t.positionGeometry.x.smoothstep(this.min,this.max),o=t.positionGeometry.y.smoothstep(this.minY,this.maxY);return e.mul(o)}mirrorFuzzy(){var e=t.positionGeometry.x.smoothstep(-this.min,-this.max),o=t.positionGeometry.y.smoothstep(this.minY,this.maxY);return e.mul(o)}},exports.LocusY=l,exports.LocusYZ=class extends l{constructor(e,t,o,s){super(e,t,o),this.slope=Math.tan((90-s)*Math.PI/180)}fuzzy(){return t.positionGeometry.y.add(t.positionGeometry.z.div(this.slope)).smoothstep(this.min,this.max)}},exports.credits=function(e,t){var o=new XMLHttpRequest;o.onreadystatechange=function(){4==this.readyState&&200==this.status&&(document.getElementById(t).innerHTML=this.responseText.split("||")[0])},(e=e.split(".")).pop(),e.push("txt"),e=e.join("."),o.open("GET",e,!0),o.send()},exports.matRotXYZ=m,exports.matRotXZY=n,exports.matRotYXZ=r,exports.matRotYZX=a,exports.matRotZXY=u,exports.matRotZYX=d,exports.processModel=function(t,o,s,i,r){return function(t){var o=[];t.traverse((t=>{if(t.isMesh){var s=t.geometry.clone().applyMatrix4(t.matrixWorld),i=t.material.clone();o.push(new e.Mesh(s,i))}})),t.clear(),t.position.set(0,0,0),t.rotation.set(0,0,0,"XYZ"),t.scale.set(1,1,1),t.add(...o)}(t),function(t,o,s,i){t.traverse((t=>{if(t.isMesh){var r=new e.MeshPhysicalNodeMaterial;Object.assign(r,t.material),r.metalness=.1,r.roughness=.6,i.colorNode&&(r.colorNode=i.colorNode()),i.positionNode&&(r.positionNode=i.positionNode({skeleton:o,posture:s})),i.normalNode&&(r.normalNode=i.normalNode({skeleton:o,posture:s})),i.emissiveNode&&(r.emissiveNode=i.emissiveNode({skeleton:o,posture:s})),t.material=r}}))}(t,o,s,r),function(t,o){var s=new e.Vector3,i=(new e.Box3).setFromObject(t,!0);i.getCenter(s),t.position.sub(s),o.x=(i.max.x+i.min.x)/2,o.y=i.min.y,o.z=(i.max.z+i.min.z)/2,o.scale=Math.max(i.max.x-i.min.x,i.max.y-i.min.y,i.max.z-i.min.z)}(t,i),t},exports.tslColorNode=v,exports.tslEmissiveNode=f,exports.tslNormalNode=function(e){return e.vertex=t.normalGeometry,e.mode=t.float(0),t.transformNormalToView(y(e)).normalize()},exports.tslPositionNode=function(e){return e.vertex=t.positionGeometry,e.mode=t.float(1),y(e)},exports.tslPosture=function(){return{head:t.uniform(t.vec3(0,0,0)),chest:t.uniform(t.vec3(0,0,0)),waist:t.uniform(t.vec3(0,0,0)),kneeLeft:t.uniform(t.vec3(0,0,0)),kneeRight:t.uniform(t.vec3(0,0,0)),ankleLeft:t.uniform(t.vec3(0,0,0)),ankleRight:t.uniform(t.vec3(0,0,0)),footLeft:t.uniform(t.vec3(0,0,0)),footRight:t.uniform(t.vec3(0,0,0)),hipLeft:t.uniform(t.vec3(0,0,0)),hip2Left:t.uniform(t.vec3(0,0,0)),hipRight:t.uniform(t.vec3(0,0,0)),hip2Right:t.uniform(t.vec3(0,0,0)),legLeft:t.uniform(t.vec3(0,0,0)),legRight:t.uniform(t.vec3(0,0,0)),elbowLeft:t.uniform(t.vec3(0,0,0)),elbowRight:t.uniform(t.vec3(0,0,0)),forearmLeft:t.uniform(t.vec3(0,0,0)),forearmRight:t.uniform(t.vec3(0,0,0)),wristLeft:t.uniform(t.vec3(0,0,0)),wristRight:t.uniform(t.vec3(0,0,0)),armLeft:t.uniform(t.vec3(0,0,0)),armRight:t.uniform(t.vec3(0,0,0))}};
