/*! disfigure v0.0.10 */
import{positionGeometry as t,float as e,vec3 as o,min as s,Fn as a,mat3 as i,If as n,normalGeometry as r,transformNormalToView as m,uniform as l}from"three/tsl";import{Vector3 as u,Mesh as g,Box3 as h,MeshPhysicalNodeMaterial as f}from"three";function p(t,e,o=0){return e*t/1e3+o}function c(t,e,o=0){return 1e3*(t-o)/e}function L(t,e){return new u(p(t[0],e.scale,e.x),p(t[1],e.scale,e.y),p(t[2],e.scale,e.z))}function v(t){var e=Object.assign(Object.create(t),t);return e.pivot=e.pivot.clone(),e.pivot.x*=-1,e}class y{constructor(t,e,o,s=0,a){this.pivot=L(e,t),this.minY=p(o[0],t.scale,t.y),this.maxY=p(o[1],t.scale,t.y),a&&(this.minX=p(a[0],t.scale,t.x),this.maxX=p(a[1],t.scale,t.x)),this.slope=Math.tan((90-s)*Math.PI/180)}mirror(){var t=v(this);return"minX"in t&&(t.minX*=-1,t.maxX*=-1),t}locus(e=t){var o=e.x,s=e.y,a=e.z;0!=this.angle&&(s=s.add(a.sub(this.pivot.z).div(this.slope)));var i=j(this.minY,this.maxY,s);return"minX"in this&&(i=i.max(j(this.minX,this.maxX,o.abs().add(s.sub(this.pivot.y))))),i}}class R{constructor(t,e,o,s=0){this.pivot=L(e,t),this.minX=p(o[0],t.scale,t.x),this.maxX=p(o[1],t.scale,t.x),this.slope=Math.tan((90-s)*Math.PI/180)}mirror(){var t=v(this);return t.minX*=-1,t.maxX*=-1,t}locus(o=t){var s=o.x,a=o.z,i=e(this.minX),n=e(this.maxX);if(0!=this.angle){var r=a.sub(this.pivot.z).div(this.slope).max(.01).mul(s.sign());i=i.sub(r),n=n.add(r)}return j(i,n,s)}}class x extends R{constructor(t,e,o,s){super(t,e,o),this.minY=p(s[0],t.scale,t.y),this.maxY=p(s[1],t.scale,t.y)}locus(o=t){var a=o.x,i=o.y,n=o.y.sub(this.pivot.y).div(4,a.sign()),r=.8;return e(1).mul(j(e(this.minX).sub(n),e(this.maxX).sub(n),a)).mul(s(j(this.minY,this.minY*r+(1-r)*this.maxY,i),j(this.maxY,this.maxY*r+(1-r)*this.minY,i))).pow(2)}}class d extends x{constructor(t,e,o,s,a=0){super(t,e,o,s),this.grown=a}locus(s=t){var a=s.x,i=s.z;if(0==this.grown)var n=s.y.sub(a.abs().mul(.2)).add(i.mul(1/6)),r=o(s.x.mul(2),s.y,s.z.min(0)).sub(o(0,this.pivot.y,0)).length().smoothstep(0,.13).pow(10);else n=s.y.sub(a.abs().mul(.2)).add(i.abs().mul(.5)),r=o(s.x.mul(2),s.y,s.z.min(0)).sub(o(0,this.pivot.y,0)).length().smoothstep(0,.065).pow(10);return e(r).mul(a.smoothstep(this.minX,this.maxX),j(this.minY,this.maxY,n).pow(2))}}class w{constructor(t,e){const o={LocusT:d,LocusX:R,LocusXY:x,LocusY:y};for(var s in e)if("_"!=s){var a=o[e[s].shift()];e[s]=new a(t,...e[s])}this._=e._,this.head=e.head,this.chest=e.chest,this.waist=e.waist,this.kneeLeft=e?.kneeLeft??e.knee,this.kneeRight=e?.kneeRight??e.knee.mirror(),this.ankleLeft=e?.ankleLeft??e.ankle,this.ankleRight=e?.ankleRight??e.ankle.mirror(),this.ankleLongLeft=e?.ankleLongLeft??e.ankleLong,this.ankleLongRight=e?.ankleLongRight??e.ankleLong.mirror(),this.legLongLeft=e?.legLongLeft??e.legLong,this.legLongRight=e?.legLongRight??e.legLong.mirror(),this.footLeft=e?.footLeft??e.foot,this.footRight=e?.footRight??e.foot.mirror(),this.legLeft=e?.legLeft??e.leg,this.legRight=e?.legRight??e.leg.mirror(),this.elbowLeft=e?.elbowLeft??e.elbow,this.elbowRight=e?.elbowRight??e.elbow.mirror(),this.forearmLeft=e?.forearmLeft??e.forearm,this.forearmRight=e?.forearmRight??e.forearm.mirror(),this.wristLeft=e?.wristLeft??e.wrist,this.wristRight=e?.wristRight??e.wrist.mirror(),this.armLeft=e?.armLeft??e.arm,this.armRight=e?.armRight??e.arm.mirror()}}const k=a((([t])=>{var e=t.cos().toVar(),o=t.sin().toVar();return i(1,0,0,0,e,o,0,o.negate(),e)})).setLayout({name:"matRotX",type:"mat3",inputs:[{name:"angle",type:"float"}]}),b=a((([t])=>{var e=t.cos().toVar(),o=t.sin().toVar();return i(e,0,o.negate(),0,1,0,o,0,e)})).setLayout({name:"matRotY",type:"mat3",inputs:[{name:"angle",type:"float"}]}),X=a((([t])=>{var e=t.cos().toVar(),o=t.sin().toVar();return i(e,o,0,o.negate(),e,0,0,0,1)})).setLayout({name:"matRotZ",type:"mat3",inputs:[{name:"angle",type:"float"}]}),Y=a((([t])=>{var e=k(t.x),o=b(t.y),s=X(t.z);return o.mul(e).mul(s)})).setLayout({name:"matRotYXZ",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),z=a((([t])=>{var e=k(t.x),o=b(t.y),s=X(t.z);return o.mul(s).mul(e)})).setLayout({name:"matRotYZX",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),N=a((([t])=>{var e=k(t.x),o=b(t.y),s=X(t.z);return e.mul(o).mul(s)})).setLayout({name:"matRotXYZ",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),V=a((([t])=>{var e=k(t.x),o=b(t.y),s=X(t.z);return e.mul(s).mul(o)})).setLayout({name:"matRotXZY",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),Z=a((([t])=>{var e=k(t.x),o=b(t.y);return X(t.z).mul(e).mul(o)})).setLayout({name:"matRotZXY",type:"mat3",inputs:[{name:"angles",type:"vec3"}]}),M=a((([t])=>{var e=k(t.x),o=b(t.y);return X(t.z).mul(o).mul(e)})).setLayout({name:"matRotZYX",type:"mat3",inputs:[{name:"angles",type:"vec3"}]});function T(t,e,o,s,a={}){var i={};return function(t,e){var o=[];t.traverse((t=>{if(t.isMesh){var s=t.geometry.clone().applyMatrix4(t.matrixWorld),a=t.material.clone();if(e[0]&&s.rotateX(e[0]),e[1]&&s.rotateY(e[1]),e[2]&&s.rotateZ(e[2]),t.isSkinnedMesh){t.pose();for(var i=s.getAttribute("position"),n=s.getAttribute("normal"),r=new u,m=0;m<i.count;m++)r.fromBufferAttribute(i,m),t.applyBoneTransform(m,r),i.setXYZ(m,...r),r.fromBufferAttribute(n,m),t.applyBoneTransform(m,r),n.setXYZ(m,...r)}var l=new g(s,a);l.frustumCulled=!1,o.push(l)}})),t.clear(),t.position.set(0,0,0),t.rotation.set(0,0,0,"XYZ"),t.scale.set(1,1,1),t.add(...o)}(t,e?._?.rot??[0,0,0]),function(t,e){var o=new u,s=(new h).setFromObject(t,!0);s.getCenter(o),t.position.sub(o),e.x=(s.max.x+s.min.x)/2,e.y=s.min.y,e.z=(s.max.z+s.min.z)/2,e.scale=Math.max(s.max.x-s.min.x,s.max.y-s.min.y,s.max.z-s.min.z)}(t,i),function(t,e,o,s,a){t.traverse((t=>{if(t.isMesh){var i=new f;Object.assign(i,t.material),Object.assign(i,a),s.colorNode&&(i.colorNode=s.colorNode()),s.positionNode&&(i.positionNode=s.positionNode({space:e,posture:o})),s.normalNode&&(i.normalNode=s.normalNode({space:e,posture:o})),s.emissiveNode&&(i.emissiveNode=s.emissiveNode({space:e,posture:o})),t.material=i}}))}(t,e=new w(i,e),o,s,a),{model:t,dims:i,space:e}}const j=a((([t,e,o])=>o.smoothstep(t,e).smoothstep(0,1).smoothstep(0,1))).setLayout({name:"smoother",type:"float",inputs:[{name:"edgeFrom",type:"float"},{name:"edgeTo",type:"float"},{name:"value",type:"float"}]});var O=a((([t,e,o,s])=>t.sub(e).mul(z(o.mul(s))).add(e))).setLayout({name:"jointRotate",type:"vec3",inputs:[{name:"pos",type:"vec3"},{name:"center",type:"vec3"},{name:"angle",type:"vec3"},{name:"amount",type:"float"}]}),A=a((([t,e,o,s])=>t.sub(e).mul(V(o.mul(s))).add(e).toVar())).setLayout({name:"jointRotate2",type:"vec3",inputs:[{name:"pos",type:"vec3"},{name:"center",type:"vec3"},{name:"angle",type:"vec3"},{name:"amount",type:"float"}]});function B(o){return o.vertex=t,o.mode=e(1),C(o)}function _(t){return t.vertex=r,t.mode=e(0),m(C(t)).normalize()}var C=a((({space:t,posture:e,mode:o,vertex:s})=>{var a=s.toVar(),i=t.armLeft.locus().toVar();n(i.greaterThan(0),(()=>{a.assign(O(a,o.mul(t.wristLeft.pivot),e.wristLeft,t.wristLeft.locus())),a.assign(O(a,o.mul(t.forearmLeft.pivot),e.forearmLeft,t.forearmLeft.locus())),a.assign(O(a,o.mul(t.elbowLeft.pivot),e.elbowLeft,t.elbowLeft.locus())),a.assign(A(a,o.mul(t.armLeft.pivot),e.armLeft,t.armLeft.locus()))}));var r=t.armRight.locus().toVar();n(r.greaterThan(0),(()=>{a.assign(O(a,o.mul(t.wristRight.pivot),e.wristRight,t.wristRight.locus())),a.assign(O(a,o.mul(t.forearmRight.pivot),e.forearmRight,t.forearmRight.locus())),a.assign(O(a,o.mul(t.elbowRight.pivot),e.elbowRight,t.elbowRight.locus())),a.assign(A(a,o.mul(t.armRight.pivot),e.armRight,t.armRight.locus()))})),a.assign(O(a,o.mul(t.head.pivot),e.head,t.head.locus())),a.assign(O(a,o.mul(t.chest.pivot),e.chest,t.chest.locus())),a.assign(O(a,o.mul(t.waist.pivot),e.waist,t.waist.locus()));var m=t.legLeft.locus().toVar();n(m.greaterThan(0),(()=>{a.assign(O(a,o.mul(t.footLeft.pivot),e.footLeft,t.footLeft.locus())),a.assign(O(a,o.mul(t.ankleLeft.pivot),e.ankleLeft,t.ankleLeft.locus())),a.assign(O(a,o.mul(t.ankleLongLeft.pivot),e.ankleLongLeft,t.ankleLongLeft.locus())),a.assign(O(a,o.mul(t.kneeLeft.pivot),e.kneeLeft,t.kneeLeft.locus())),a.assign(O(a,o.mul(t.legLongLeft.pivot),e.legLongLeft,t.legLongLeft.locus())),a.assign(O(a,o.mul(t.legLeft.pivot),e.legLeft,m))}));var l=t.legRight.locus().toVar();return n(l.greaterThan(0),(()=>{a.assign(O(a,o.mul(t.footRight.pivot),e.footRight,t.footRight.locus())),a.assign(O(a,o.mul(t.ankleRight.pivot),e.ankleRight,t.ankleRight.locus())),a.assign(O(a,o.mul(t.ankleLongRight.pivot),e.ankleLongRight,t.ankleLongRight.locus())),a.assign(O(a,o.mul(t.kneeRight.pivot),e.kneeRight,t.kneeRight.locus())),a.assign(O(a,o.mul(t.legLongRight.pivot),e.legLongRight,t.legLongRight.locus())),a.assign(O(a,o.mul(t.legRight.pivot),e.legRight,l))})),a}));function F(){return{head:l(o(0,0,0)),chest:l(o(0,0,0)),waist:l(o(0,0,0)),kneeLeft:l(o(0,0,0)),kneeRight:l(o(0,0,0)),ankleLeft:l(o(0,0,0)),ankleRight:l(o(0,0,0)),footLeft:l(o(0,0,0)),footRight:l(o(0,0,0)),legLeft:l(o(0,0,0)),legLongLeft:l(o(0,0,0)),legRight:l(o(0,0,0)),legLongRight:l(o(0,0,0)),ankleLongLeft:l(o(0,0,0)),ankleLongRight:l(o(0,0,0)),elbowLeft:l(o(0,0,0)),elbowRight:l(o(0,0,0)),forearmLeft:l(o(0,0,0)),forearmRight:l(o(0,0,0)),wristLeft:l(o(0,0,0)),wristRight:l(o(0,0,0)),armLeft:l(o(0,0,0)),armRight:l(o(0,0,0))}}export{d as LocusT,R as LocusX,w as Space,p as decode,c as encode,N as matRotXYZ,V as matRotXZY,Y as matRotYXZ,z as matRotYZX,Z as matRotZXY,M as matRotZYX,T as processModel,j as smoother,_ as tslNormalNode,B as tslPositionNode,F as tslPosture};
